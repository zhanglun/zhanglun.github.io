{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blogs/  基于PNPM的项目改造/",
    "result": {"data":{"site":{"siteMetadata":{"title":"张小伦的网络日志","description":"欢迎来到张小伦的网络日志 \n\t\t一个记录生活，分享心得的博客","menu":[{"id":"home","name":"首页","url":"/"},{"id":"blog","name":"博文","url":"/blogs"},{"id":"category","name":"分类","url":"/categories"},{"id":"archive","name":"归档","url":"/archives"},{"id":"lab","name":"实验室","url":"/labs"},{"id":"about","name":"关于我","url":"/about"}]}},"markdownRemark":{"id":"c680d1f1-ecba-55c1-a99b-50b06d42ba3d","html":"<h2 class=\"heading subtitle heading\" id=\"背景\" style=\"position:relative;\"><a href=\"#%E8%83%8C%E6%99%AF\" aria-label=\"背景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景</h2>\n<p class=\"para\">因为历史原因，前端项目的代码按照业务模块，分散在不同的代码仓库中。可以复用的业务代码以npm package的形式共享。每个业务模块都是基于Nuxt.js的SSG，部署方式是将各模块构建产出物上传至服务器上，使用Nginx代理接口和托管HTML等静态资源。</p>\n<p class=\"para\">看起来好像是一个很常规的操作。但实际上在各方面都存在一些让人非常不痛快的点，且不说：</p>\n<ul>\n<li>\n<p class=\"para\">npm包的日常开发调试流程繁琐。</p>\n</li>\n<li>\n<p class=\"para\">共享代码的更新迫使依赖的业务模块必须更新。</p>\n</li>\n<li>\n<p class=\"para\">各项目冗余了构建相关的配置。</p>\n</li>\n</ul>\n<p class=\"para\">当这套流程在技术水平普遍不高的团队中应用时，还会有更多挑战：</p>\n<ul>\n<li>\n<p class=\"para\">代码组织没有可参考的标准。什么样的代码必须提升至共享，什么样的代码属于强业务？</p>\n</li>\n<li>\n<p class=\"para\">历史原因和开发人员技术能力问题导致的代码腐败。</p>\n</li>\n<li>\n<p class=\"para\">业务模块使用的Webpack、Vue等基础依赖及其生态版本，没有强的一致性约束，导致版本参差不齐。</p>\n</li>\n<li>\n<p class=\"para\">引入Nuxt.js的SSG想做微前端。效果没达成，反而增加了项目维护的难度。</p>\n</li>\n<li>\n<p class=\"para\">项目间形成了孤岛，无法全局观，限制了开发人员的想象力，一定程度上促进了项目代码的腐败。</p>\n</li>\n</ul>\n<p class=\"para\">其他更多挑战就不一一列举了，总而言之就是很“痛”。</p>\n<p class=\"para\">当遇到本地化项目的时候，痛苦更上一层楼。我需要同时维护所有项目的代码版本。在众多项目和它们的分支中来回切换，逐渐迷失了自己。</p>\n<p class=\"para\">在针对这些场景和痛点进行了一番技术调研之后，我决定尝试基于PNPM对现有项目进行Monorepo的改造。</p>\n<h2 class=\"heading subtitle heading\" id=\"Monorepo-VS-Polyrepo\" style=\"position:relative;\"><a href=\"#Monorepo-VS-Polyrepo\" aria-label=\"Monorepo VS Polyrepo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Monorepo VS Polyrepo</h2>\n<p class=\"para\"><a href=\"https://nrwl.io/\" class=\"link-underline\">Nrwl 团队</a>创建了<a href=\"https://monorepo.tools/\" class=\"link-underline\">https://monorepo.tools/</a>向大家解释Monorepo相关的概念和工具。</p>\n<p class=\"para\">Monorepo是一个包含了多个独立项目，且项目间有明确的关联关系的仓库。可以看到两个重点：多个独立项目，项目间有明确关系。如果只是将项目放在同一个仓库，彼此之间没有明确关系，那这个不能称之为Monorepo架构；如果仓库只包含多个项目，没有拆分出来的封装和复用的代码，那只是一个大库，只能算是MonoLith架构。</p>\n<p class=\"para\">与Monorepo相反的方案可以称之为“Polyrepo”，也是当下标准的开发模式：每个仓库都应一个模块、应用或者项目。彼此通过其他的仓库来共享可复用的代码，每个项目都有自己的构建流程和部署流程。这也是当前团队的开发模式。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36241648de064a6c80a102c1a430872f/d30ee/b47a4b0392b140a9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.48936170212767%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"b47a4b0392b140a9\"\n        title=\"b47a4b0392b140a9\"\n        src=\"/static/36241648de064a6c80a102c1a430872f/1d69c/b47a4b0392b140a9.png\"\n        srcset=\"/static/36241648de064a6c80a102c1a430872f/4dcb9/b47a4b0392b140a9.png 188w,\n/static/36241648de064a6c80a102c1a430872f/5ff7e/b47a4b0392b140a9.png 375w,\n/static/36241648de064a6c80a102c1a430872f/1d69c/b47a4b0392b140a9.png 750w,\n/static/36241648de064a6c80a102c1a430872f/d30ee/b47a4b0392b140a9.png 980w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">Polyrepo模式存在代码共享难，重复代码多，依赖更新烦，配置升级乱等问题。Monorepo模式下只会有一个项目仓库，在文件夹之间共享代码十分简单；项目可以保持同一个版本，减少升级的心智负担；复用同一套配置，升级和维护都很方便。</p>\n<p class=\"para\">文章中提到了 Monorepo的<a href=\"https://monorepo.tools/#monorepo-tools\" class=\"link-underline\">工具对比</a>，相对比较全面，感兴趣的朋友可以看看。我选择的是PNPM的方案，因为这是当下改造成本最低的方案。未来可能会再研究 <a href=\"https://github.com/vercel/turborepo\" class=\"link-underline\">TurboRepo</a> 和 <a href=\"https://github.com/microsoft/rushstack\" class=\"link-underline\">Rush</a>。</p>\n<h2 class=\"heading subtitle heading\" id=\"基于-PNPM-的-Monorepo\" style=\"position:relative;\"><a href=\"#%E5%9F%BA%E4%BA%8E-PNPM-%E7%9A%84-Monorepo\" aria-label=\"基于 PNPM 的 Monorepo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>基于 PNPM 的 Monorepo</h2>\n<p class=\"para\">PNPM项目的初衷是<strong>节约磁盘空间并提升安装速度</strong>。PNPM将所有文件都存储在同一个位置，当软件包被被安装时，包里的文件会硬链接到这一位置，而不会占用额外的磁盘空间，可以跨项目地共享同一版本的依赖。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ccc605894f53bec436093d90add2d5d0/751eb/9a0c9b12a7f5ad7e.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.87234042553191%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABqElEQVQoz22SSW8TQRCF/f//DRxBIsDNSChCESIQx3bGnqX3fcacPtTtJSBxeKrpV1WvX9X0yqWZK0I5IYznZZB0o0K5RCwnQl7webnV+b96btwlv/Kt+ExcyUE5jsIwGc9gQ4OJ5bUmL4SykOYTaf7dLryKrs43LJiQ0T41UrvIKA3CRnSISB/YCs1kPa4Kp5leOb7v+oZB+zZdc9jbzOQL3SB5GQQ2lpas7o7SIpRCDVumaeSln5BCY5Tl577n7v6RD19/8NzL5rQJqlDQcW7uKq67rGPXXQqb8MGj9ZGDMriQCKnw1I28uVvz9uOXi+DF4dEmJp+bu30/4VImlIKNick4BmURxjHqkdEH4ryQTyc2veT9+oF36we2vSAtS+tdxVIIuRDnuRX7XBrOopnDpOhGydOhR1uHMhbvA5vDxOdvv/h0/8huqA6rYKl/udxEKvEqODe0c401l3JzUaP2kbE6Nw4T0q3vH8GbWD43tMKUMSFiYkLH0qJNuU1Tx6yo3/Fi4L+CUhueux5Zn0l9NsYiXd3nnk3XsTuOHIXiMMkWrxDW8QeODPO30pIt3wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9a0c9b12a7f5ad7e\"\n        title=\"9a0c9b12a7f5ad7e\"\n        src=\"/static/ccc605894f53bec436093d90add2d5d0/1d69c/9a0c9b12a7f5ad7e.png\"\n        srcset=\"/static/ccc605894f53bec436093d90add2d5d0/4dcb9/9a0c9b12a7f5ad7e.png 188w,\n/static/ccc605894f53bec436093d90add2d5d0/5ff7e/9a0c9b12a7f5ad7e.png 375w,\n/static/ccc605894f53bec436093d90add2d5d0/1d69c/9a0c9b12a7f5ad7e.png 750w,\n/static/ccc605894f53bec436093d90add2d5d0/78797/9a0c9b12a7f5ad7e.png 1125w,\n/static/ccc605894f53bec436093d90add2d5d0/aa440/9a0c9b12a7f5ad7e.png 1500w,\n/static/ccc605894f53bec436093d90add2d5d0/751eb/9a0c9b12a7f5ad7e.png 2920w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">PNPM 内置的 Workspace 能力提供了对 Monorepo 的支持。Workspace 的创建非常简单，包含<a href=\"https://pnpm.io/zh/pnpm-workspace_yaml\" class=\"link-underline\"><code>pnpm-workspace.yaml</code></a> 文件的目录就是一个PNPM的Workspace。它定义了Workspace的根目录，可以从workspace中包含或者排除你选择的目录。</p>\n<deckgo-highlight-code language=\"yaml\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">packages:\n  # all packages in direct subdirs of packages/\n  - &#39;packages/*&#39;\n  # all packages in subdirs of components/\n  - &#39;components/**&#39;\n  # exclude packages that are inside test directories\n  - &#39;!**/test/**&#39;</code>\n        </deckgo-highlight-code>\n<h2 class=\"heading subtitle heading\" id=\"保留历史记录渐进迁移\" style=\"position:relative;\"><a href=\"#%E4%BF%9D%E7%95%99%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%B8%90%E8%BF%9B%E8%BF%81%E7%A7%BB\" aria-label=\"保留历史记录渐进迁移 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>保留历史记录，渐进迁移</h2>\n<p class=\"para\">团队的各个项目都在进行正常的开发迭代，技术改造不能对需求上线造成影响，需要有一个方案可以让技术改造和业务迭代并行。</p>\n<p class=\"para\">当下的难点在于：</p>\n<ul>\n<li>\n<p class=\"para\">Monorepo的改造，必然是要有一个新仓库的，原有项目仓库中的代码和新仓库之间的代码如何时刻保持同步</p>\n</li>\n<li>\n<p class=\"para\">如何统一项目的依赖。</p>\n</li>\n<li>\n<p class=\"para\">如何打造一套全新的构建流程。</p>\n</li>\n</ul>\n<p class=\"para\">针对难点1我想到的方案是：Git Submodule。Git Submodule 允许你将一个 Git 仓库作为另一个 Git 仓库的子目录。 它能让你将另一个仓库克隆到自己的项目中，同时还保持提交的独立。完美解决了代码同步的问题。</p>\n<p class=\"para\">在改造阶段，对每个项目的修改主要包含：</p>\n<ul>\n<li>\n<p class=\"para\">依赖升级之后的可能存在的兼容性改动</p>\n</li>\n<li>\n<p class=\"para\">编译打包相关的配置改动</p>\n</li>\n</ul>\n<p class=\"para\">这些工作可以单独拉去分支进行改造，通过验证之后合并回主干分支。当所有项目改造完成后，整体的升级也算是顺利完成了。</p>\n<h2 class=\"heading subtitle heading\" id=\"依赖升级\" style=\"position:relative;\"><a href=\"#%E4%BE%9D%E8%B5%96%E5%8D%87%E7%BA%A7\" aria-label=\"依赖升级 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>依赖升级</h2>\n<p class=\"para\">理想很美好，但是现实很残忍。当 PNPM 和 Git Submodule 配置之后，第一步的依赖升级就挡住前进的道路。各项目依赖的Vue和Webpack版本五花八门。Vue的版本有v2.6.12和v2.7.10，Webpack的版本有v3.x、v4.x和v5.x。</p>\n<h3 class=\"heading\" id=\"Webpack\" style=\"position:relative;\"><a href=\"#Webpack\" aria-label=\"Webpack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Webpack</h3>\n<p class=\"para\">安装完依赖之后，第一次执行 <code>nuxt dev</code>便遇到了警告</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16ea5acbb45fc23ed218a789e3347b21/d53ff/a985eaa27bcd20f6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.531914893617024%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVQY01WPOw7CMBBEc5YkInb8VWITKPiEKh1SKi4AB4D7a9AsciSK1Xh/s8/VbVZ4PDT2ewvnA2IM8N7DGIO+7+XtnJPQWouyx4gxwlqLtm3RNI1odTp1WFeFlCy8j3DOyjCXaciFYtB13dajhhDkXdf1Zloti8braXA88LJHSkmCw4VwGAahYY2ErPEQ83EcJd8Ic9phvu4QgobWPyIu0UwpJVoISVOi9DjPfDO833t83haXM78bkXPCNE1CRWOSkbhQkobKA6zlnP8Ivy3/meWNRZg/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"a985eaa27bcd20f6\"\n        title=\"a985eaa27bcd20f6\"\n        src=\"/static/16ea5acbb45fc23ed218a789e3347b21/1d69c/a985eaa27bcd20f6.png\"\n        srcset=\"/static/16ea5acbb45fc23ed218a789e3347b21/4dcb9/a985eaa27bcd20f6.png 188w,\n/static/16ea5acbb45fc23ed218a789e3347b21/5ff7e/a985eaa27bcd20f6.png 375w,\n/static/16ea5acbb45fc23ed218a789e3347b21/1d69c/a985eaa27bcd20f6.png 750w,\n/static/16ea5acbb45fc23ed218a789e3347b21/d53ff/a985eaa27bcd20f6.png 1068w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">显然，需要将Webpack生态相关的依赖升级到统一的版本。可以使用<code>pnpm why -r</code>快速检查指定包的依赖关系，所有项目的依赖扫了一遍，一个个升级实在过于繁琐。<code>pnpm update</code>根据指定的范围更新软件包的最新版本，配置项**<code>--recursive</code>**同允许我们同时在所有子目录中使用运行更新，就像刚才使用<code>pnpm why</code>时一样。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pnpm --recursive update\n# 更新子目录深度为 100 以内的所有包\npnpm --recursive update --depth 100\n# 将每个包中的 typescript 更新为最新版本\npnpm --recursive update typescript@latest</code>\n        </deckgo-highlight-code>\n<p class=\"para\">在指定更新某些包时，一定要记得带上版本，只有包名是不会更新的。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pnpm update --recursive webpack@^4 css-loader@^3 sass-loader@^10 webpack-merge@^5</code>\n        </deckgo-highlight-code>\n<h3 class=\"heading\" id=\"Vue-和-Nuxt\" style=\"position:relative;\"><a href=\"#Vue-%E5%92%8C-Nuxt\" aria-label=\"Vue 和 Nuxt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vue 和 Nuxt</h3>\n<p class=\"para\">更新了Webpack版本后，又遇到了预料之中的<code>Vue packages version mismatch</code> 。检查发现，实际项目中使用的Vue版本都是v2.6.12，v2.7.10的版本来自一些第三方库的依赖。考虑到升级Vue可能带来的影响，决定先保留Vue的版本为v2.6.12。</p>\n<p class=\"para\">再次执行 <code>nuxt dev</code>时，得到了新的错误。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">✖ Nuxt Fatal Error                                                                       \n                                                                                        \nError:                                                                                   \n                                                                                        \nVue packages version mismatch:                                                           \n                                                                                        \n- vue@2.6.12                                                                             \n- vue-server-renderer@2.7.10                                                             \n                                                                                        \nThis may cause things to work incorrectly. Make sure to use the same version for both.</code>\n        </deckgo-highlight-code>\n<p class=\"para\">使用 <code>pnpm why</code> 查看 vue-server-renderer ，会发现最终的顶级依赖是 <code>nuxt</code>，我试图将其版本锁定在项目使用的 v2.11.0，但是依旧是相同的错误。将原先的 yarn.lock文件和 pnpm-lock.yml 进行比对后发现，后者的版本更新到了v2.7.10。从 node_module s中一层层从 nuxt 到 vue-server-renderer 的引用关系如下</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">nuxt@2.11.0 \n\t-&gt; @nuxt/core@2.11.0 \n\t\t-&gt; @nuxt/vue-renderer@2.11.0 \n\t\t\t-&gt;vue-server-renderer@^2.6.11</code>\n        </deckgo-highlight-code>\n<p class=\"para\">因为^的关系，vue-server-renderer 会安装到最新的v2.7.10。</p>\n<blockquote class=\"quote\">\n<p class=\"para\">为什么老项目本身能够运行？<br>\n项目中的 yarn.lock 文件创建的时间很早，锁定的vue-server-renderer是v2.6.12，与vue版本一致，所有可以运行。</p>\n</blockquote>\n<p class=\"para\">看起来需要将Vue的版本锁定为v2.7.10。社区中有不少关于将Vue升级到2.7的踩坑文章，似乎没有太多问题。接下来结合项目当前对Vue的使用情况，梳理出一个可行的改造方案。在此之前，先将解决开发模式启动的问题。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pnpm update -r vue@2.7.10 nuxt@2.15.8</code>\n        </deckgo-highlight-code>\n<h3 class=\"heading\" id=\"Babel\" style=\"position:relative;\"><a href=\"#Babel\" aria-label=\"Babel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Babel</h3>\n<p class=\"para\">同样的，使用 <code>update -r</code> 批量更新<a href=\"mailto:vue@2.7.10\" class=\"link-underline\">vue@2.7.10</a>、<a href=\"mailto:nuxt@2.15.8\" class=\"link-underline\">nuxt@2.15.8</a>，游戏进入到下一关。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">/.nuxt/client.js: Unknown option: base.configFile. Check out http://babeljs.io/docs/usage/options/ for more information about options.\n\nA common cause of this error is the presence of a configuration options object without the corresponding preset name. Example:\n\nInvalid:\n  `{ presets: [{option: value}] }`\nValid:\n  `{ presets: [[&#39;presetName&#39;, {option: value}]] }`\n\nFor more detailed information on preset configuration, please see http://babeljs.io/docs/plugins/#pluginpresets-options.</code>\n        </deckgo-highlight-code>\n<p class=\"para\">这是babel-core和将babel升级到v7.x，bable-loader升级到v8.x 就能解决这个问题。我直接将它们升级到latest版本。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pnpm update --recursive babel-loader@latest @babel/core@latest @babel/preset-env@latest</code>\n        </deckgo-highlight-code>\n<p class=\"para\">因为项目中用到了jsx，对应的还需要升级相关的插件，具体细节可以查看<a href=\"https://github.com/vuejs/jsx-vue2\" class=\"link-underline\">这里</a>。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pnpm add -D -r @vue/babel-preset-jsx @vue/babel-helper-vue-jsx-merge-props</code>\n        </deckgo-highlight-code>\n<p class=\"para\">现在 <code>nuxt dev</code>可以顺利运行，但是页面上出现了下图中的错误。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/115d0b8ebdb653f04a888827db99aa40/a6ec4/9f00de739e51124a.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.936170212765955%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3klEQVQY03WPa0uEYBBG/f//rIV0vaSul1aSdH29G62179gJLQgX+nAYBh6eOWPo5xAdeUjksqQBS/zELfH5CGzmyOOWhujYR59cdBIgVYGUOdIqZOiQod1h6PIV7du8exaja9H4HsUpRMURdRIzX0qWtka6BmkUUq9USLcWDMjQ7zDWi9o/0pgHlGORHS3yIKDOMqZLyVVVfE0jMg4sK9P4w7b3v/MPQ6pye6exH6kdk8K1qZIYdT7T5y/MtdqC9yb/sRl+2gdG84HWMTfD1HHIw4C3suCq9oX3RveG32/Fdv5FaIgsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"9f00de739e51124a\"\n        title=\"9f00de739e51124a\"\n        src=\"/static/115d0b8ebdb653f04a888827db99aa40/1d69c/9f00de739e51124a.png\"\n        srcset=\"/static/115d0b8ebdb653f04a888827db99aa40/4dcb9/9f00de739e51124a.png 188w,\n/static/115d0b8ebdb653f04a888827db99aa40/5ff7e/9f00de739e51124a.png 375w,\n/static/115d0b8ebdb653f04a888827db99aa40/1d69c/9f00de739e51124a.png 750w,\n/static/115d0b8ebdb653f04a888827db99aa40/78797/9f00de739e51124a.png 1125w,\n/static/115d0b8ebdb653f04a888827db99aa40/a6ec4/9f00de739e51124a.png 1438w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">考虑到本次升级将nuxt从v2.11.0升级到了v2.15.8，猜测可能是nuxt导致的问题。</p>\n<h3 class=\"heading\" id=\"Nuxt\" style=\"position:relative;\"><a href=\"#Nuxt\" aria-label=\"Nuxt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nuxt</h3>\n<p class=\"para\">通过打断点发现，在加载Layout目录中的组件时，出现了一个 undefined。检查发现是Layout目录中包含了一个<code>microEvent.js</code>，文件内容是导出了几个工具函数，没有默认导出对象（export default)。</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">/*\n* 定义一个事件系统，用于让微应用和主应用通讯\n*/\n\nconst microEvents = {}\n\nexport const addMicroAppEventListener = (appName, ev, cb) =&gt; {\n  if (!microEvents[appName]) {\n    microEvents[appName] = {}\n  }\n  if (!microEvents[appName][ev]) {\n    microEvents[appName][ev] = []\n  }\n  microEvents[appName][ev].push(cb)\n}\nexport const removeMicroAppEventListener = (appName, ev, cb) =&gt; {\n  if (microEvents[appName] &amp;&amp; microEvents[appName][ev]) {\n    microEvents[appName][ev] = microEvents[appName][ev].filter(it =&gt; it !== cb)\n  }\n}\nexport const dispatchMicroAppEvent = appName =&gt; (ev, ...args) =&gt; {\n  if (microEvents[appName] &amp;&amp; microEvents[appName][ev]) {\n    microEvents[appName][ev].forEach(fn =&gt; fn.apply(null, args))\n  }\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">对比了v2.10.1和v2.15.8的产物后发现，两个版本中，microEvent.js都被解析为 undefined，在2.10.1版本下，nuxt在解析了layouts目录中的文件后，直接构建了一个<code>layouts</code>对象。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c1cff635944fe3ab7065b37e58acc959/8da59/f591b997c392d816.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.148936170212767%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfklEQVQY042PSQ7DMAhFfRfbgAFPUtL2/hf7Vayk3UVZPDEIniDMphi9wd1gZlDVH0ctTCDKSDkhxoiU0i1hNsO275i9wl1gXhZqBVIEOf+HHwm3UfF5v9AOSe/wMcDC53Jc8eKS3omDa4GZgjlDzeC1gZjWyyIMOvpn/uTCL5PrdEYt5yOFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"f591b997c392d816\"\n        title=\"f591b997c392d816\"\n        src=\"/static/c1cff635944fe3ab7065b37e58acc959/1d69c/f591b997c392d816.png\"\n        srcset=\"/static/c1cff635944fe3ab7065b37e58acc959/4dcb9/f591b997c392d816.png 188w,\n/static/c1cff635944fe3ab7065b37e58acc959/5ff7e/f591b997c392d816.png 375w,\n/static/c1cff635944fe3ab7065b37e58acc959/1d69c/f591b997c392d816.png 750w,\n/static/c1cff635944fe3ab7065b37e58acc959/78797/f591b997c392d816.png 1125w,\n/static/c1cff635944fe3ab7065b37e58acc959/aa440/f591b997c392d816.png 1500w,\n/static/c1cff635944fe3ab7065b37e58acc959/8da59/f591b997c392d816.png 2742w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">而在2.15.8版本中，则调用了<code>sanitizeComponent</code> 方法。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/46158b6d670b59d5e25fda3a59d4991c/5522e/99826cd730e888df.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.212765957446805%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVQY01WQy07EMBRD+yMM0yQ36c27mc5DRUJs+P9POqgVC1gcWfLCtjz1mllLpNVMSpEY/6OqpJTQxeO9R0ROdSIEEVIQNAjOuZNptMxzVPZ957GtjFtjHZWxdVqv5JwpOZP+lBwFISzUGNi7spWF4B3ihWn0wrYWXs8nLSuaFkJWnBesMzhneZ8Nl6vhOhuMmTHmUMtltrz9+tbak2m0wrFyrB1Vz70r3y/l0ZSYMj547kX4GsKtLGiMp5fV87kKH92TUzpvOAJ/ACN7dxv62WuCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"99826cd730e888df\"\n        title=\"99826cd730e888df\"\n        src=\"/static/46158b6d670b59d5e25fda3a59d4991c/1d69c/99826cd730e888df.png\"\n        srcset=\"/static/46158b6d670b59d5e25fda3a59d4991c/4dcb9/99826cd730e888df.png 188w,\n/static/46158b6d670b59d5e25fda3a59d4991c/5ff7e/99826cd730e888df.png 375w,\n/static/46158b6d670b59d5e25fda3a59d4991c/1d69c/99826cd730e888df.png 750w,\n/static/46158b6d670b59d5e25fda3a59d4991c/78797/99826cd730e888df.png 1125w,\n/static/46158b6d670b59d5e25fda3a59d4991c/aa440/99826cd730e888df.png 1500w,\n/static/46158b6d670b59d5e25fda3a59d4991c/5522e/99826cd730e888df.png 2680w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">在<code>sanitizeComponent(Component)</code> 中没有对入参为 undefined 时做兼容处理，导致出现报错。</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">export function sanitizeComponent (Component) {\n  // If Component already sanitized\n  if (Component.options &amp;&amp; Component._Ctor === Component) {\n    return Component\n  }\n  if (!Component.options) {\n    Component = Vue.extend(Component) // fix issue #6\n    Component._Ctor = Component\n  } else {\n    Component._Ctor = Component\n    Component.extendOptions = Component.options\n  }\n  // If no component name defined, set file path as name, (also fixes #5703)\n  if (!Component.options.name &amp;&amp; Component.options.__file) {\n    Component.options.name = Component.options.__file\n  }\n  return Component\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">在 nuxtjs 的 <a href=\"https://nuxtjs.org/releases\" class=\"link-underline\">releases</a> 记录中找到了对应改动的版本在v2.13.0，<a href=\"https://github.com/nuxt/nuxt.js/pull/7139/commits/530d3d76f863b5094b0e6d057ea78038dbd7a8bf\" class=\"link-underline\">这里</a>是提交记录。</p>\n<h2 class=\"heading subtitle heading\" id=\"结束语\" style=\"position:relative;\"><a href=\"#%E7%BB%93%E6%9D%9F%E8%AF%AD\" aria-label=\"结束语 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结束语</h2>\n<p class=\"para\">pnpm的改造成本不算太高，主要的成本体现在项目依赖的升级这件事情上。不过好在版本的跨度没有太大，整个过程较为平滑。但是这么多项目，如果一次性批量升级依赖，风险还是太大了。接下来要做的事情是，在每个项目的迭代中逐步升级依赖，减少升级带来的风险。与依赖升级可以同时进行的事情是，将项目的构建部署和工具包的发布等工程化相关的流程梳理清楚，收敛为一套标准的流程。所有的工作串起来后，完整的 Monorepo 方案就能顺利落地。</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E8%83%8C%E6%99%AF\">背景</a></p>\n</li>\n<li>\n<p><a href=\"#monorepo-vs-polyrepo\">Monorepo VS Polyrepo</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%9F%BA%E4%BA%8E-pnpm-%E7%9A%84-monorepo\">基于 PNPM 的 Monorepo</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BF%9D%E7%95%99%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%B8%90%E8%BF%9B%E8%BF%81%E7%A7%BB\">保留历史记录，渐进迁移</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%BE%9D%E8%B5%96%E5%8D%87%E7%BA%A7\">依赖升级</a></p>\n<ul>\n<li><a href=\"#webpack\">Webpack</a></li>\n<li><a href=\"#vue-%E5%92%8C-nuxt\">Vue 和 Nuxt</a></li>\n<li><a href=\"#babel\">Babel</a></li>\n<li><a href=\"#nuxt\">Nuxt</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%BB%93%E6%9D%9F%E8%AF%AD\">结束语</a></p>\n</li>\n</ul>","headings":[{"id":"背景","depth":2,"value":"背景"},{"id":"Monorepo-VS-Polyrepo","depth":2,"value":"Monorepo VS Polyrepo"},{"id":"基于-PNPM-的-Monorepo","depth":2,"value":"基于 PNPM 的 Monorepo"},{"id":"保留历史记录渐进迁移","depth":2,"value":"保留历史记录，渐进迁移"},{"id":"依赖升级","depth":2,"value":"依赖升级"},{"id":"Webpack","depth":3,"value":"Webpack"},{"id":"Vue-和-Nuxt","depth":3,"value":"Vue 和 Nuxt"},{"id":"Babel","depth":3,"value":"Babel"},{"id":"Nuxt","depth":3,"value":"Nuxt"},{"id":"结束语","depth":2,"value":"结束语"}],"frontmatter":{"title":"  基于PNPM的项目改造","date":"2022-08-23","cover":"https://res.cloudinary.com/practicaldev/image/fetch/s--5LB7xZGh--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/o8e2at4huuuv08y24jvg.png","description":null,"categories":["技术应用"],"tags":["笔记","架构"]}},"previous":{"fields":{"slug":"/blogs/学习项目管理-项目管理的意义/"},"frontmatter":{"title":"学习项目管理-项目管理的意义"}},"next":{"fields":{"slug":"/blogs/学习项目管理-项目的生命周期/"},"frontmatter":{"title":"学习项目管理-项目的生命周期","tags":["项目管理","读书笔记"],"categories":["解决方案"],"status":"publish"}}},"pageContext":{"id":"c680d1f1-ecba-55c1-a99b-50b06d42ba3d","previousPostId":"fbfce5da-2ee5-557f-bb56-e4c422e457a3","nextPostId":"7d2852d0-5a2d-5330-b837-5587ba3aa506"}},
    "staticQueryHashes": ["2841359383"]}