{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blogs/使用SQLite做为Rust项目的数据库/",
    "result": {"data":{"site":{"siteMetadata":{"title":"张小伦的网络日志","description":"欢迎来到张小伦的网络日志 \n\t\t一个记录生活，分享心得的博客","menu":[{"id":"home","name":"首页","url":"/"},{"id":"blog","name":"博文","url":"/blogs"},{"id":"category","name":"分类","url":"/categories"},{"id":"archive","name":"归档","url":"/archives"},{"id":"lab","name":"实验室","url":"/labs"},{"id":"about","name":"关于我","url":"/about"}]}},"markdownRemark":{"id":"5f5178b9-b58c-5a37-b41b-01a72a2f9a7d","html":"<p class=\"para\">在使用 Rust 开发应用时，需要用到 SQLite 做为应用的本地数据库。在目前Rust的生态中，SQLite相关的 Crate 还是挺多的。我选择了 <a href=\"https://github.com/diesel-rs/diesel\" class=\"link-underline\"><strong>Diesel</strong></a> 这个ORM库。原因无他，文档全，star多，使用相对简单。本文我将通过一个简单的案例，演示如何使用 Diesel，在 SQLite 中实现对数据的 CRUD。</p>\n<h2 class=\"heading subtitle heading\" id=\"安装依赖\" style=\"position:relative;\"><a href=\"#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96\" aria-label=\"安装依赖 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装依赖</h2>\n<p class=\"para\">首先将Diesel添加到项目依赖中，Diesel推荐使用 <code>.env</code> 文件来管理项目的环境变量，所以还需要再加上 dotenv这个工具。</p>\n<deckgo-highlight-code language=\"yaml\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">[dependencies]\ndiesel = { version = &quot;1.4.4&quot;, features = [&quot;postgres&quot;] }\ndotenv = &quot;0.15.0&quot;</code>\n        </deckgo-highlight-code>\n<p class=\"para\">初次之外，Diesel提供一个独立的命令行工具：diesel-cli，用以帮助管理项目。这是一个独立的包，不会影响项目的结构和代码。只需要安装在系统中即可。</p>\n<deckgo-highlight-code language=\"yaml\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">cargo install diesel-cli</code>\n        </deckgo-highlight-code>\n<p class=\"para\">diesel 是一个支持MySQL，PostgreSQL和SQLite的ORM工具。这三种数据库都有各自的依赖。</p>\n<ul>\n<li>\n<p class=\"para\"><a href=\"https://www.postgresql.org/docs/current/libpq.html\" class=\"link-underline\"><strong>libpq</strong></a> PostgreSQL 依赖的客户端二进制</p>\n</li>\n<li>\n<p class=\"para\"><a href=\"https://dev.mysql.com/doc/c-api/8.0/en/c-api-implementations.html\" class=\"link-underline\"><strong>libmysqlclient</strong></a>  MySQL 依赖的客户端二进制</p>\n</li>\n<li>\n<p class=\"para\"><a href=\"https://www.sqlite.org/index.html\" class=\"link-underline\"><strong>libsqlite3</strong></a> SQlite 依赖的客户端二进制</p>\n</li>\n</ul>\n<p class=\"para\">默认情况下，diesel-cli 在安装时会检查这些依赖，你可以事先在你的操作系统中安装好对应的依赖，也可以在安装cli时使用<code>-no-default-features</code> 跳过。你也可以在安装时指定对应的数据库。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">cargo install diesel_cli --no-default-features --features postgres\ncargo install diesel_cli --no-default-features --features sqlite</code>\n        </deckgo-highlight-code>\n<h2 class=\"heading subtitle heading\" id=\"在项目中设置Diesel\" style=\"position:relative;\"><a href=\"#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%AE%BE%E7%BD%AEDiesel\" aria-label=\"在项目中设置Diesel permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>在项目中设置Diesel</h2>\n<p class=\"para\">Diesel 通过设置的环境变量 <strong>DATABASE_URL</strong> 找到我们的数据库。在项目中创建 <code>.env</code> 文件做为项目的环境相关的配置文件，通过dotenv来解析。比如，将SQLite的DB文件放在项目根目录中。</p>\n<deckgo-highlight-code language=\"yaml\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">echo DATABASE_URL=./my.db &gt; .env</code>\n        </deckgo-highlight-code>\n<p class=\"para\">然后为项目添加依赖。</p>\n<deckgo-highlight-code language=\"json\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">[dependencies]\ndiesel = { version = &quot;^1.1.0&quot;, features = [&quot;sqlite&quot;] }\ndotenv = &quot;0.9.0&quot;</code>\n        </deckgo-highlight-code>\n<p class=\"para\">接下来就可以初始化数据库，创建脚本了。</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">diesel setup\ndiesel migration generate create_posts</code>\n        </deckgo-highlight-code>\n<p class=\"para\">如果一切顺利的话，项目中会出现一个 <code>my.db</code> 文件和一个 <code>migrations</code> 目录。在 <code>migrations</code>\n目录中有一个<code>up.sql</code>和一个<code>down.sql</code>。<code>migrations</code> 中文件可以帮我们在项目开发过程中，高效演进和完善数据库模型。当你在对数据库进行migration时，实际上是执行了这个版本中的<code>up.sql</code>。而在回滚时，执行的则是<code>down.sql</code>。</p>\n<p class=\"para\">另外 setup 时还会创建一个<code>diesel.toml</code> 。这是 diesel-cli 在当前项目中的配置文件，CLI 默认会从Cargo.toml文件所在的目录中查找这个文件。当然你也可以通过环境变 <strong>DIESEL_CONFIG_FILE</strong>修改。配置文件在创建时会自动填入以下配置，这段配置指定了 diesel 创建的数据库 schema 保存的文件路径。</p>\n<deckgo-highlight-code language=\"sql\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">[print_schema]\nfile = &quot;src/schema.rs&quot;</code>\n        </deckgo-highlight-code>\n<h2 class=\"heading subtitle heading\" id=\"创建数据库模型\" style=\"position:relative;\"><a href=\"#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B\" aria-label=\"创建数据库模型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建数据库模型</h2>\n<p class=\"para\">接下来创建第一个版本的数据库模型。分别修改<code>up.sql</code> 和<code>down.sql</code>。</p>\n<deckgo-highlight-code language=\"sql\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE posts (\n  id INTEGER NOT NULL PRIMARY KEY,\n  title VARCHAR NOT NULL,\n  body TEXT NOT NULL,\n  published BOOLEAN NOT NULL DEFAULT &#39;f&#39;\n)</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"sql\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">DROP TABLE channels</code>\n        </deckgo-highlight-code>\n<p class=\"para\">SQL语句准备就绪，我们可以试着使用这个版本。</p>\n<deckgo-highlight-code language=\"sql\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">diesel migration run </code>\n        </deckgo-highlight-code>\n<p class=\"para\">通常来说，如果命令执行成功，会在 src 目录下创建一个 <code>schema.rs</code>。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">table! {\n    posts (id) {\n        id -&gt; Integer,\n        title -&gt; Text,\n        body -&gt; Text,\n        published -&gt; Bool,\n    }\n}</code>\n        </deckgo-highlight-code>\n<blockquote class=\"quote\">\n<p class=\"para\">前文提到过数据库schema输出的路径可以通过diesel.toml 设置</p>\n</blockquote>\n<p class=\"para\">每次执行 diesel migration run 或者 diesel migration redo 时，新的schema都会创建并输出到目录中。</p>\n<h2 class=\"heading subtitle heading\" id=\"写点代码试试\" style=\"position:relative;\"><a href=\"#%E5%86%99%E7%82%B9%E4%BB%A3%E7%A0%81%E8%AF%95%E8%AF%95\" aria-label=\"写点代码试试 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>写点代码试试</h2>\n<p class=\"para\">现在项目准备就绪了，我们写一点Rust代码，实现post数据的展示。首先先实现数据库的连接。</p>\n<h3 class=\"heading\" id=\"连接数据库创建-Post-结构体\" style=\"position:relative;\"><a href=\"#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E5%BB%BA-Post-%E7%BB%93%E6%9E%84%E4%BD%93\" aria-label=\"连接数据库创建 Post 结构体 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>连接数据库，创建 Post 结构体</h3>\n<p class=\"para\">在<code>src/lib.rs</code>中实现连接数据库的逻辑。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">pub mod schema;\npub mod models;\n#[macro_use]\nextern crate diesel;\nextern crate dotenv;\n\nuse diesel::prelude::*;\nuse diesel::sqlite::SqliteConnection;\nuse dotenv::dotenv;\nuse std::env;\n\npub fn establish_connection() -&gt; SqliteConnection {\n    dotenv().ok();\n\n    let database_url = env::var(&quot;DATABASE_URL&quot;)\n        .expect(&quot;DATABASE_URL must be set&quot;);\n    SqliteConnection::establish(&amp;database_url)\n        .expect(&amp;format!(&quot;Error connecting to {}&quot;, database_url))\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">然后在<code>src/models.rs</code>中创建刚才声明的两个 Module。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">#[derive(Queryable)]\npub struct Post {\n    pub id: i32,\n    pub title: String,\n    pub body: String,\n    pub published: bool,\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\"><code>#[derive(Queryable)]</code> 将生成从 SQL 查询加载 Post 结构所需的所有代码。数据库的schema由Diesel自动创建，这一点已经在前文中提及，这里就不再赘述。</p>\n<h3 class=\"heading\" id=\"读取-Post-数据\" style=\"position:relative;\"><a href=\"#%E8%AF%BB%E5%8F%96-Post-%E6%95%B0%E6%8D%AE\" aria-label=\"读取 Post 数据 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>读取 Post 数据</h3>\n<p class=\"para\">接下来实现一个简单的数据读取的过程。新建文件<code>src/bin/show_posts.rs</code> ，这个文件做的事情是连接数据库、查询数据和输出数据。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">extern crate diesel_demo;\nextern crate diesel;\n\nuse self::diesel_demo::*;\nuse self::models::*;\nuse self::diesel::prelude::*;\n\nfn main() {\n    use diesel_demo::schema::posts::dsl::*;\n\n    let connection = establish_connection();\n    let results = posts.filter(published.eq(true))\n        .limit(5)\n        .load::&lt;Post&gt;(&amp;connection)\n        .expect(&quot;Error loading posts&quot;);\n\n    println!(&quot;Displaying {} posts&quot;, results.len());\n    for post in results {\n        println!(&quot;{}&quot;, post.title);\n        println!(&quot;----------\\n&quot;);\n        println!(&quot;{}&quot;, post.body);\n    }\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">试着执行<code>cargo run --bin show_posts</code>看看效果，编译通过之后控制台会输出以下内容：</p>\n<deckgo-highlight-code language=\"bash\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">Displaying 0 posts</code>\n        </deckgo-highlight-code>\n<h3 class=\"heading\" id=\"写入-Post-数据\" style=\"position:relative;\"><a href=\"#%E5%86%99%E5%85%A5-Post-%E6%95%B0%E6%8D%AE\" aria-label=\"写入 Post 数据 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>写入 Post 数据</h3>\n<p class=\"para\">因为现在数据库中还没有数据，我们需要创建Post数据。首先在<code>src/models.rs</code>中定义结构体<code>NewPost</code>，然后在<code>src/lib.rs</code>中实现<code>create_post</code>。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">use super::schema::posts;\n\n#[derive(Insertable)]\n#[table_name=&quot;posts&quot;]\npub struct NewPost&lt;&#39;a&gt; {\n    pub title: &amp;&#39;a str,\n    pub body: &amp;&#39;a str,\n}</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">use self::models::{Post, NewPost};\n\npub fn create_post&lt;&#39;a&gt;(conn: &amp;SqliteConnection, title: &amp;&#39;a str, body: &amp;&#39;a str) -&gt; usize {\n    use schema::posts;\n\n    let new_post = NewPost {\n        title,\n        body,\n    };\n\n    diesel::insert_into(posts::table)\n        .values(&amp;new_post)\n        .execute(conn)\n        .expect(&quot;Error saving new post&quot;)\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">现在已经万事俱备，接下来新建<code>src/bin/write_post.rs</code>，实现写入一条Post的逻辑。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">extern crate diesel_demo;\nextern crate diesel;\n\nuse self::diesel_demo::*;\nuse std::io::{stdin, Read};\n\nfn main() {\n    let connection = establish_connection();\n\n    println!(&quot;What would you like your title to be?&quot;);\n    let mut title = String::new();\n    stdin().read_line(&amp;mut title).unwrap();\n    let title = &amp;title[..(title.len() - 1)]; // Drop the newline character\n    println!(&quot;\\nOk! Let&#39;s write {} (Press {} when finished)\\n&quot;, title, EOF);\n    let mut body = String::new();\n    stdin().read_to_string(&amp;mut body).unwrap();\n\n    let post = create_post(&amp;connection, title, &amp;body);\n    println!(&quot;\\nSaved draft {} with id {}&quot;, title, post.id);\n}\n\n#[cfg(not(windows))]\nconst EOF: &amp;&#39;static str = &quot;CTRL+D&quot;;\n\n#[cfg(windows)]\nconst EOF: &amp;&#39;static str = &quot;CTRL+Z&quot;;</code>\n        </deckgo-highlight-code>\n<p class=\"para\">首先创建一个数据库的连接，在打印一句提示语之后，调用Rust内置的stdin，获取IO输入。最后使用两个条件编译，针对不同系统绑定结束的快捷键。</p>\n<p class=\"para\">让我们试着执行写入逻辑的脚本<code>cargo run --bin write_post</code>。如果编译成功的话，你可以在控制台进行用户交互了。下图是一个演示效果的截图。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9e620b6c035a68990c96c044e3aaab98/ea64c/915a1ec542eba300.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.04255319148936%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4klEQVQoz4VRWY6FMAzrbYBCF/at0Erc/0weOU95QvMx82HFSRPHSo21LfxoEbcG/eJwHAf2fUfOGfd9Y9s2rOsqOd+maUJKSXrICfKu62CthQkhIIwO4+FFMKVLhkspeJ5HRK/rU2Nv27bw3sM5JyIEOesiyKGSC+4rS+QwxeZ5Rt/3GIZBQM6Bpmm+YK415YaNMUbEGCSqCDdzq7ogp5O/wB5DJ3oL3oq53k3jeZ5SX5ZFcn0jtMYemjG8R13XAlr/Hauqkqg3+g+GR+fvcQN/i5EbWaMDvtMdm1WU8c3fgj+C1Nzx9iySyQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"915a1ec542eba300\"\n        title=\"915a1ec542eba300\"\n        src=\"/static/9e620b6c035a68990c96c044e3aaab98/1d69c/915a1ec542eba300.png\"\n        srcset=\"/static/9e620b6c035a68990c96c044e3aaab98/4dcb9/915a1ec542eba300.png 188w,\n/static/9e620b6c035a68990c96c044e3aaab98/5ff7e/915a1ec542eba300.png 375w,\n/static/9e620b6c035a68990c96c044e3aaab98/1d69c/915a1ec542eba300.png 750w,\n/static/9e620b6c035a68990c96c044e3aaab98/ea64c/915a1ec542eba300.png 1116w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 class=\"heading\" id=\"修改记录的数据\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E6%94%B9%E8%AE%B0%E5%BD%95%E7%9A%84%E6%95%B0%E6%8D%AE\" aria-label=\"修改记录的数据 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修改记录的数据</h3>\n<p class=\"para\">现在我们已经成功写入了一条数据，但是执行<code>cargo run --bin show_posts</code> 并不会返回我们预期的数据。因为上一步虽然写入了一条Post数据，但是数据的<code>published</code>默认是<code>false</code>。而show_posts中数据查询的逻辑是<code>.filter(published.eq(true))</code> ，这样无法查找出想要的数据，我们需要提供修改数据的能力。新建<code>src/bin/publish_post.rs</code>，对数据进行修改。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">extern crate diesel_demo;\nextern crate diesel;\n\nuse self::diesel::prelude::*;\nuse self::diesel_demo::*;\nuse self::models::Post;\nuse std::env::args;\n\nfn main() {\n    use diesel_demo::schema::posts::dsl::{posts, published};\n\n    let id = args().nth(1).expect(&quot;publish_post requires a post id&quot;)\n        .parse::&lt;i32&gt;().expect(&quot;Invalid ID&quot;);\n    let connection = &amp;mut establish_connection();\n\n    let _ = diesel::update(posts.find(id))\n        .set(published.eq(true))\n        .execute(connection)\n        .expect(&amp;format!(&quot;Unable to find post {}&quot;, id));\n\n    let post: models::Post = posts\n        .find(id)\n        .first(connection)\n        .unwrap_or_else(|_| panic!(&quot;Unable to find post {}&quot;, id));\n    println!(&quot;Published post {}&quot;, post.title);\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">执行 <code>cargo run --bin publish_post 1</code></p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9ef922596a303d90091b3b7b7e882a52/c6ff8/bc893815ef4b882f.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.702127659574469%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaklEQVQI122MSQ7DIADE8pwCIiplCXsQ/P9NrkqvOVjyYTyHeAm0EZgseF+SWiq9d+acrLW2l1K2jzHw3pNSIsaItXYTQuA8T6SUHM45wuUI2eKuzx7f902t/+MfrTVyzhhj0Frv8AmlFF+TgkC+eZZe1gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bc893815ef4b882f\"\n        title=\"bc893815ef4b882f\"\n        src=\"/static/9ef922596a303d90091b3b7b7e882a52/1d69c/bc893815ef4b882f.png\"\n        srcset=\"/static/9ef922596a303d90091b3b7b7e882a52/4dcb9/bc893815ef4b882f.png 188w,\n/static/9ef922596a303d90091b3b7b7e882a52/5ff7e/bc893815ef4b882f.png 375w,\n/static/9ef922596a303d90091b3b7b7e882a52/1d69c/bc893815ef4b882f.png 750w,\n/static/9ef922596a303d90091b3b7b7e882a52/c6ff8/bc893815ef4b882f.png 1088w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p class=\"para\">数据修改成功！再次执行 show_post 命令查看返回的结果。</p>\n<p class=\"para\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/50576260d63f0e58101a8173477119fd/ddc6c/02305536c18ed125.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.872340425531917%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmElEQVQY05WPWwrEIBRDXY5Vq/ioTwqlFPe/owzXwRZmvvpxIMHcBJkJAsZLxLghxjjw3sM5h5wzUkoopQw9/cxs23NDhBDAbBVwTWLfd1zXhd47zvPEcRzDU7DWOiBNpdZarOsKrTWMMTfkWWsVMX2PaFEpdYeFEOCc/7Esy3gjSE/Is1lE0DdmcCKlfAUbK+JZ+Q28Lf0Ag1Cb/HCIMa0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"02305536c18ed125\"\n        title=\"02305536c18ed125\"\n        src=\"/static/50576260d63f0e58101a8173477119fd/1d69c/02305536c18ed125.png\"\n        srcset=\"/static/50576260d63f0e58101a8173477119fd/4dcb9/02305536c18ed125.png 188w,\n/static/50576260d63f0e58101a8173477119fd/5ff7e/02305536c18ed125.png 375w,\n/static/50576260d63f0e58101a8173477119fd/1d69c/02305536c18ed125.png 750w,\n/static/50576260d63f0e58101a8173477119fd/78797/02305536c18ed125.png 1125w,\n/static/50576260d63f0e58101a8173477119fd/aa440/02305536c18ed125.png 1500w,\n/static/50576260d63f0e58101a8173477119fd/ddc6c/02305536c18ed125.png 1534w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 class=\"heading\" id=\"删除-Post-数据\" style=\"position:relative;\"><a href=\"#%E5%88%A0%E9%99%A4-Post-%E6%95%B0%E6%8D%AE\" aria-label=\"删除 Post 数据 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>删除 Post 数据</h3>\n<p class=\"para\">到目前为止，CRUD中的”CRU”都已经实现了，现在就差最后的“D”，也就是删除操作了。按照前面的思路，我们依样画葫芦，创建<code>src/bin/delete_post.rs</code>，在这个文件中实现数据库数据的删除。</p>\n<deckgo-highlight-code language=\"rust\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">use diesel::prelude::*;\nuse diesel_demo_step_3_sqlite::*;\nuse std::env::args;\n\nfn main() {\n    use diesel_demo_step_3_sqlite::schema::posts::dsl::*;\n\n    let target = args().nth(1).expect(&quot;Expected a target to match against&quot;);\n    let pattern = format!(&quot;%{}%&quot;, target);\n\n    let connection = &amp;mut establish_connection();\n    let num_deleted = diesel::delete(posts.filter(title.like(pattern)))\n        .execute(connection)\n        .expect(&quot;Error deleting posts&quot;);\n\n    println!(&quot;Deleted {} posts&quot;, num_deleted);\n}</code>\n        </deckgo-highlight-code>\n<p class=\"para\">执行 <code>cargo run --bin delete_post Good</code> 将会删除数据。</p>\n<h2 class=\"heading subtitle heading\" id=\"结束语\" style=\"position:relative;\"><a href=\"#%E7%BB%93%E6%9D%9F%E8%AF%AD\" aria-label=\"结束语 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结束语</h2>\n<p class=\"para\">Diesel 是一个相当不错的ORM库，社区活跃，文档详细。针对不同类型数据的接入都有详细的代码案例，极大降低了学习和使用的成本。未来将结合具体的案例展示更加详细和深入的使用教程。</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96\">安装依赖</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E8%AE%BE%E7%BD%AEdiesel\">在项目中设置Diesel</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B\">创建数据库模型</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%86%99%E7%82%B9%E4%BB%A3%E7%A0%81%E8%AF%95%E8%AF%95\">写点代码试试</a></p>\n<ul>\n<li><a href=\"#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E5%BB%BA-post-%E7%BB%93%E6%9E%84%E4%BD%93\">连接数据库，创建 Post 结构体</a></li>\n<li><a href=\"#%E8%AF%BB%E5%8F%96-post-%E6%95%B0%E6%8D%AE\">读取 Post 数据</a></li>\n<li><a href=\"#%E5%86%99%E5%85%A5-post-%E6%95%B0%E6%8D%AE\">写入 Post 数据</a></li>\n<li><a href=\"#%E4%BF%AE%E6%94%B9%E8%AE%B0%E5%BD%95%E7%9A%84%E6%95%B0%E6%8D%AE\">修改记录的数据</a></li>\n<li><a href=\"#%E5%88%A0%E9%99%A4-post-%E6%95%B0%E6%8D%AE\">删除 Post 数据</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E7%BB%93%E6%9D%9F%E8%AF%AD\">结束语</a></p>\n</li>\n</ul>","headings":[{"id":"安装依赖","depth":2,"value":"安装依赖"},{"id":"在项目中设置Diesel","depth":2,"value":"在项目中设置Diesel"},{"id":"创建数据库模型","depth":2,"value":"创建数据库模型"},{"id":"写点代码试试","depth":2,"value":"写点代码试试"},{"id":"连接数据库创建-Post-结构体","depth":3,"value":"连接数据库，创建 Post 结构体"},{"id":"读取-Post-数据","depth":3,"value":"读取 Post 数据"},{"id":"写入-Post-数据","depth":3,"value":"写入 Post 数据"},{"id":"修改记录的数据","depth":3,"value":"修改记录的数据"},{"id":"删除-Post-数据","depth":3,"value":"删除 Post 数据"},{"id":"结束语","depth":2,"value":"结束语"}],"frontmatter":{"title":"使用SQLite做为Rust项目的数据库","date":"2022-01-21","cover":"https://www.notion.so/images/page-cover/met_goya_1789.jpg","description":null,"categories":["技术应用"],"tags":["SQLite","Rust"]}},"previous":{"fields":{"slug":"/blogs/《架构师修炼之道》摘录10-展示设计决策/"},"frontmatter":{"title":"《架构师修炼之道》摘录10-展示设计决策"}},"next":{"fields":{"slug":"/blogs/《架构师修炼之道》摘录09-召开架构设计研讨会/"},"frontmatter":{"title":"《架构师修炼之道》摘录09-召开架构设计研讨会","tags":["笔记","架构"],"categories":["解决方案"],"status":"publish"}}},"pageContext":{"id":"5f5178b9-b58c-5a37-b41b-01a72a2f9a7d","previousPostId":"53b2b604-20a5-57ab-ac36-97ee93bab078","nextPostId":"73787b37-190d-51ad-a22b-199b30557909"}},
    "staticQueryHashes": ["2841359383"]}